package edu.ucla.wise.client;

import java.io.IOException;
import java.io.PrintWriter;

import javax.servlet.ServletException;
import javax.servlet.http.HttpServlet;
import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;
import javax.servlet.http.HttpSession;

import edu.ucla.wise.commons.Interviewer;
import edu.ucla.wise.commons.Surveyor_Application;
import edu.ucla.wise.commons.User;
import edu.ucla.wise.commons.WISE_Application;


/*
Display a single survey page as a form to be filled out
*/

public class view_form extends HttpServlet
{
	static final long serialVersionUID = 1000;
	public void service(HttpServletRequest req, HttpServletResponse res)
       throws ServletException, IOException
	{
        // prepare for writing
        PrintWriter out;
        res.setContentType("text/html");
        out = res.getWriter();

        HttpSession session = req.getSession(true);
        //Surveyor_Application s = (Surveyor_Application)session.getAttribute("SurveyorInst");

        //if session is new, then show the session expired info
        if (session.isNew())
        {
            res.sendRedirect(Surveyor_Application.shared_file_url + "error" + WISE_Application.html_ext);
            return;
        }
        
        //get the user from session
        User theUser = (User) session.getAttribute("USER");      
        if(theUser==null)
        {
            out.println("<p>Error: Can't find the user info.</p>");
            return;
        }
        
        //check if it is an interview process
        Interviewer inv = (Interviewer) session.getAttribute("INTERVIEWER");
        if(inv!=null)
        {
            //get the current page
            String pageid = req.getParameter("p");
            //set the current page
            theUser.currentPage= theUser.currentSurvey.get_page(pageid);         
        }

        //get the output string of the current page        
        String p_output = theUser.currentPage.render_page(theUser);

        // display the current page only if it returns output
        if(p_output!=null && !p_output.equalsIgnoreCase(""))
        {
            out.println("<html><head>" +
            		"<link rel='stylesheet' href='"+ theUser.currentSurvey.study_space.style_url +"style.css' type='text/css'>\n"+
            		"<script type='text/javascript' language='JavaScript1.1' src='"+ Surveyor_Application.shared_file_url +"survey.js'></script>");
            out.println(p_output);            
        }
        // otherwise, skip the current page
        else
        {
            //redirect to the next page by outputting hidden field values and running JS submit()
            out.println("<html>");
            out.println("<head></head>");
            out.println("<body>");
            out.println("<form name='mainform' method='post' action='readform'>");
            out.println("<input type='hidden' name='action' value=''>");
            if ( (theUser.currentSurvey.is_last_page(theUser.currentPage.id)) || (theUser.currentPage.final_page) )
                out.println("<input type='hidden' name='nextPage' value='DONE'>");
            else
            {
                //if the id of the next page is not set in the survey xml file (with value=NONE),
                //then get its id from the page hash table in the survey class.
                if ( theUser.currentPage.next_page.equalsIgnoreCase("NONE"))
                  out.println("<input type='hidden' name='nextPage' value='"+ theUser.currentSurvey.next_page(theUser.currentPage.id).id+"'>");
                else
                  //otherwise, assign the page id directly to the form
                  out.println("<input type='hidden' name='nextPage' value='"+ theUser.currentPage.next_page+"'>");
            }
            out.println("</form>");
            out.println("<script LANGUAGE='JavaScript1.1'>document.mainform.submit();</script>");
            out.println("</body></html>");            
        }
        out.close();
	}

}